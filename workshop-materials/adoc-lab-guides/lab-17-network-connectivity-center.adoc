= Lab 17: Network Connectivity Center Implementation
:toc:
:toc-placement: auto
:toclevels: 2
:sectnums:
:imagesdir: ../docs/diagrams
:source-highlighter: rouge

// Generated by Copilot

== Overview

This lab implements Network Connectivity Center infrastructure and configuration in your GCP Landing Zone using Terraform. You will deploy resources to establish centralized network connectivity management and multi-cloud interconnectivity.

== Folder Structure

* `terraform/` – Terraform configuration files (`main.tf`, `variables.tf`, `outputs.tf`, `terraform.tfvars.example`)
* `scripts/` – (Empty, add any helper scripts here)
* `docs/` – (Empty, add any documentation here)

== Configuration Details

=== Required terraform.tfvars Changes

Before running Terraform, you must update the following variables in `terraform.tfvars`:

*Essential Configuration:*

* `project_id` - Your main GCP project ID
* `ncc_hub_name` - Name for the Network Connectivity Center hub
* `region` - GCP region (default: us-central1)
* `zone` - GCP zone (default: us-central1-a)

*Hub Configuration:*

* `create_ncc_hub` - Set to `true` if creating a new NCC hub
* `hub_description` - Description for the NCC hub
* `hub_labels` - Labels to apply to the hub

*Spoke Configuration:*

* `spoke_networks` - List of VPC networks to connect as spokes
* `spoke_subnets` - Subnet configurations for spokes
* `enable_private_google_access` - Enable private Google access

*Network Security:*

* `firewall_rules` - Custom firewall rules for spoke networks
* `allowed_ip_ranges` - IP ranges allowed for inter-spoke communication
* `enable_global_routing` - Enable global routing for the hub

*IAM Configuration:*

* `ncc_admin_members` - List of users/groups with NCC admin access
* `ncc_viewer_members` - List of users/groups with NCC viewer access

*Optional Features:*

* `create_sample_spokes` - Set to `true` to create sample spoke networks
* `enable_monitoring` - Enable monitoring and alerting for NCC

== Prerequisites

* Lab 16 completed
* Google Cloud SDK (`gcloud`) installed and authenticated
* Terraform installed
* Bash shell (Ubuntu recommended)
* Valid GCP project and billing enabled

== Steps to Execute

=== 1. Prepare Environment

[source,bash]
----
cd ~/workshop-materials/solutions/lab-17-Network-connectivity-center/terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with the following required changes:
# 1. Update 'project_id' with your actual GCP project ID
# 2. Set 'ncc_hub_name' with your desired hub name
# 3. Configure 'spoke_networks' with your VPC networks
# 4. Update 'allowed_ip_ranges' for your network topology
# 5. Modify IAM member lists with actual user/group emails
# 6. Set 'create_sample_spokes' to true if you want to deploy test networks
# 7. Configure 'enable_global_routing' based on your requirements
# 8. Customize hub labels and descriptions as needed
----

=== 2. Initialize Terraform

[source,bash]
----
terraform init
----

=== 3. Review the Plan

[source,bash]
----
terraform plan -var-file=terraform.tfvars
----

=== 4. Apply the Configuration

[source,bash]
----
terraform apply -var-file=terraform.tfvars
# Type 'yes' to confirm
----

=== 5. Review Outputs

[source,bash]
----
terraform output
----

== Cleanup

[source,bash]
----
terraform destroy -var-file=terraform.tfvars
# Type 'yes' to confirm
----

== Resources Created

* Network Connectivity Center hub
* Spoke network attachments
* Inter-spoke connectivity configurations
* Routing and firewall policies
* Monitoring and alerting setup

== Notes

* Generated by Copilot
* Ensure proper IAM permissions are configured before execution
* Review and customize variables according to your environment
* Monitor resource usage and costs
* Verify network connectivity after deployment

== Troubleshooting

* Verify GCP authentication: `gcloud auth list`
* Check project permissions: `gcloud projects get-iam-policy PROJECT_ID`
* Validate Terraform configuration: `terraform validate`
* Check NCC hub status: `gcloud network-connectivity hubs list`
* Verify spoke attachments: `gcloud network-connectivity spokes list`

== Additional Resources

=== Network Architecture Considerations

[TIP]
====
Network Connectivity Center implements a hub-and-spoke topology:

* **Central Hub**: Single point of connectivity management
* **Spoke Networks**: Individual VPC networks connected to the hub
* **Inter-Spoke Communication**: Controlled routing between spoke networks
* **Global Connectivity**: Unified network management across regions
* **Scalable Design**: Easy addition of new spoke networks
====

=== Security Best Practices

[WARNING]
====
Important security considerations for NCC implementation:

* Review and restrict `allowed_ip_ranges` to only necessary networks
* Implement least-privilege IAM policies for NCC access
* Monitor inter-spoke traffic patterns and unusual connectivity
* Use network tags to control firewall rule application
* Enable audit logging for all NCC configuration changes
* Consider using VPC Service Controls for additional security
====

=== Connectivity Validation

[NOTE]
====
After deployment, validate connectivity:

* **Hub Status**: Check that the NCC hub is active and healthy
* **Spoke Attachments**: Verify all spokes are properly attached
* **Routing Tables**: Confirm routes are propagated correctly
* **Inter-Spoke Tests**: Test connectivity between spoke networks
* **Monitoring Setup**: Ensure alerts are configured and working
* **Performance Metrics**: Monitor latency and throughput
====

=== Cost Optimization

[IMPORTANT]
====
To optimize Network Connectivity Center costs:

* Use regional routing when global routing is not required
* Monitor data transfer costs between spokes
* Implement traffic filtering to reduce unnecessary inter-spoke communication
* Consider spoke consolidation for low-traffic networks
* Set up billing alerts for unexpected cost increases
* Regularly review and clean up unused spoke attachments
====

=== Advanced Configuration

==== Hub-and-Spoke vs. Mesh Topology

[cols="2,3,3"]
|===
|Aspect |Hub-and-Spoke |Mesh Network

|Complexity
|Lower - centralized management
|Higher - distributed management

|Scalability
|High - easy spoke addition
|Limited - N(N-1)/2 connections

|Cost
|Lower - fewer connections
|Higher - more connections

|Performance
|Two-hop communication
|Direct communication

|Security
|Centralized policy enforcement
|Distributed policy management
|===

==== Monitoring and Alerting

[source,bash]
----
# Check hub status
gcloud network-connectivity hubs describe HUB_NAME \
    --project=PROJECT_ID

# List all spokes
gcloud network-connectivity spokes list \
    --hub=HUB_NAME \
    --project=PROJECT_ID

# Monitor routing tables
gcloud compute routes list \
    --project=PROJECT_ID \
    --filter="priority<=1000"
----

=== Troubleshooting Common Issues

==== Spoke Connection Failures

[source,bash]
----
# Check spoke status
gcloud network-connectivity spokes describe SPOKE_NAME \
    --hub=HUB_NAME \
    --project=PROJECT_ID

# Verify VPC network exists
gcloud compute networks describe NETWORK_NAME \
    --project=PROJECT_ID

# Check IAM permissions
gcloud projects get-iam-policy PROJECT_ID \
    --flatten="bindings[].members" \
    --filter="bindings.role:networkconnectivity"
----

==== Routing Issues

[source,bash]
----
# Check effective routes
gcloud compute networks get-effective-routes NETWORK_NAME \
    --project=PROJECT_ID

# Test connectivity
gcloud compute ssh INSTANCE_NAME \
    --zone=ZONE \
    --command="ping -c 3 TARGET_IP"

# Check firewall rules
gcloud compute firewall-rules list \
    --filter="network:NETWORK_NAME"
----
